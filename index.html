<!doctype html><meta charset=utf-8>

<meta name=viewport content="width=device-width, height=device-height, initial-scale=1">

<style>
	* {
		word-break: break-word;
	}
	
	table, td, th {
		border: 2px solid gray;
		border-collapse: collapse;
	}
	td, th {
		padding: 0;
		font-family: sans-serif;
	}
	th {
		background: #CDF;
		padding: .25em .5em;
	}
	[hidden] {display:none !important;}
	table { border: 4px solid black; }
	th, td { border-bottom: 5px solid black; }
	td[data-type] { min-width: 10em;}
	td:not([data-type]) {text-align:center;}
	
	td span {
		display: inline-block;
		padding: .25em .5em;
	}
	td button { }
	
	file-label[data-type="rom"] {
		background: #00F3;
	}
	th[data-type="rom"] {
		background: #00D6;
	}
	file-label[data-type="patch"] {
		background: #F0F3;
	}
	th[data-type="patch"] {
		background: #D0D6;
	}
	file-label[data-type="out"] {
		background: #0F03;
	}
	th[data-type="out"] {
		background: #0D06;
	}
	.crc button {
		color: #D00;
		font-style: italic;
	}
	.filename {
		line-break: anywhere;
	/*	display: inline;*/
		font-family: serif;
	}
	.crc {
		font-family: monospace;
		padding: .25em .25em;
		word-spacing: -73%;
		display: flex;
	}
	.crc > span:nth-child(2) {
		flex-grow: 1;
	}
	#\$item_list td {
		height: 3em;
	}
	file-label {
		display: block;
		margin: 1px;
		border: 2px solid purple;
		border-radius: 10px;
	}
	.drop {
		background: orange;
	}
</style>

<!--<script src="js/locale.js"></script>-->
<script src="js/MarcFile.js"></script>
<script src="js/crc.js"></script>
<script src="js/formats/ips.js"></script>
<!--
<script src="js/formats/ups.js"></script>
<script src="js/formats/aps.js"></script>
<script src="js/formats/bps.js"></script>
<script src="js/formats/rup.js"></script>
<script src="js/formats/ppf.js"></script>
<script src="js/formats/pmsr.js"></script>
	  <script src="js/formats/vcdiff.js"></script>
-->
<script src="js/zip.js/zip.js"></script>
<script src="js/zip.js/inflate.js"></script>

<script src="main.js"></script>

<input type=file multiple id=$file>
<hr>
<table id=$table>
	<tr>
		<th data-type=rom> rom files <th><th data-type=patch> patch files <th><th data-type=out> output
	<tbody id=$item_list>
</table>
<button onclick="for (let x of document.getElementsByClassName('ack'))x.onclick()">Apply</button>

<script>
	zip.useWebWorkers = false
	
	function upload(files) {
		for (let f of files) {
			if (f.type=='application/zip') {
				zip.createReader(
					new zip.BlobReader(f),
					z=>{
						z.getEntries(entries=>{
							for (let e of entries)
								new File(e).insert($item_list)
						})
					},
					z=>alert("error loading .zip")
				)
			} else {
				new File(f).insert($item_list)
			}
		}
	}
	
	$file.onchange = ev=>{upload($file.files);$file.value=null}
	
	document.ondragover = ev=>{
		if (ev.dataTransfer.types.includes("Files")) {
			ev.preventDefault()
			ev.dataTransfer.dropEffect = 'copy'
		}
	}
	document.ondrop = ev=>{
		if (ev.dataTransfer.files.length) {
			ev.preventDefault()
			upload(ev.dataTransfer.files)
			//let c = findCell()
		}
	}
	
	let dragging
	function dropzone(cell) {
		let n = false
		cell.ondragover = ev=>{
			ev.dataTransfer.dropEffect = 'move'
			ev.preventDefault()
		}
		cell.ondrop = ev=>{
			if (dragging && ev.dataTransfer.getData('text/x-drag')) {
				cell.classList.remove('drop')
				let d = dragging
				dragging = null
				let p = d.parentNode
				if (cell.firstChild) {
					if (!p) return
					p.append(cell.firstChild)
				}
				d.hidden = false
				cell.append(d)
				clean_rows($item_list)
			}
		}
	}
	function findCell(t) {
		if (t instanceof Text)
			t = t.parentNode
		if (t)
			return t.closest('td[data-type]')
	}
	function moved(ev) {
		if (![...ev.dataTransfer.items].find(x=>x.type=='text/x-drag'))
			return
		let x = findCell(ev.target)
		let y = findCell(ev.relatedTarget)
		if (x==y) return
		return x
	}
	document.ondragend = ev=>{
		if (dragging) {
			dragging.hidden = false
			dragging = null
		}
	}
	document.ondragenter = ev=>{
		let m = moved(ev)
		if (m) {
			m.classList.add('drop')
			ev.preventDefault()
		}
	}
	document.ondragleave = ev=>{
		let m = moved(ev)
		if (m)
			m.classList.remove('drop')
	}
	$item_list.ondragstart = ev=>{
		if (ev.target.tagName=='FILE-LABEL') {
			dragging = ev.target
			window.setTimeout(e=>{
				ev.target.hidden = true
			}, 2)
			
			ev.dataTransfer.setData('text/x-drag', 1)
			ev.dataTransfer.effectAllowed = 'move'
		}
	}
	function add_row(tbody) {
		let row = new row_template().$root
		row.querySelectorAll('td[data-type]').forEach(x=>dropzone(x))
		tbody.append(row)
		return row
	}
	function clean_rows(tbody) {
		let rows = tbody.rows
		if (rows.length<1 || rows[rows.length-1].querySelector('file-label'))
			add_row(tbody)
		else if (rows.length>=2) {
			let last2 = rows[rows.length-2]
			if (!last2.querySelector('file-label'))
				last2.remove()
		}
	}
	clean_rows($item_list)
	
	function apply_row(row) {
		let c = row.cells
		let rom = c.rom.firstChild
		let patch = c.patch.firstChild
		if (rom) {
			rom = File.of(rom)
			patch = patch && File.of(patch)
			apply(rom, patch).then(file=>{
				c.out.replaceChildren(file.$elem)
			})
		}
	}
	
	async function apply(rom, patch) {
		if (rom && !patch) {
			return rom.clone('out')
		}
		await Promise.all([rom.ready(), patch.ready()])
		let ips = parseIPSFile(patch.mf)
		let out = ips.apply(rom.mf)
		out.fileName = rom.name
		return new File(out)
		
//		let ready=0
//		let rom, patch
//		let load = ()=>{
//			if (++ready==2) {
				
				
				
//			}
//		}
		//rom = new MarcFile(rom, load)
		//patch = new MarcFile(patch, load)
	}
</script>
